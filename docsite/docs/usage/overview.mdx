---
sidebar_position: 2
title: Overview
toc_max_heading_level: 4
---
import Tabs from '@theme/Tabs';
import TabItem from '@theme/TabItem';
import CodeBlock from '@theme/CodeBlock';
import AIOExample from "../../src/components/AIOExample";
import FileExample from "../../src/components/FileExample";
import TreeDirectory from '../../src/components/snippets/_directoryTree.mdx'
import TreeCompose from '../../src/components/snippets/_composeTree.mdx'
import ComposeExample from '../../src/components/snippets/_composeExample.mdx'

## Key Concepts

There are three parts to using Komodo Import (KI). **Which Inputs, Configuration, and Outputs are used are all defined using environmental variables.**

### Inputs

This is what KI reads to generate [Komodo Resources](https://komo.do/docs/resources). These are existing, docker-related resources on an individual machine such as 

* [Docker Compose projects](https://docs.docker.com/compose/how-tos/project-name/) (`compose.yaml`)
* Docker containers

### Configuration

These are **environmental variables** supplied to KI to:

* set defaults for Komodo Resources (image registry, auto update, etc.)
* define required fields for Komodo Resources (Server Name, Run Directory, etc.)
* define settings for how KI to interacts with Komodo (API Key, existing Resource behavior, etc.)
* define what [Outputs](#outputs) KI uses (log to file, export to Komodo, etc.)

### Outputs

These are where and how KI puts the Resources created from [Inputs](#inputs):

* Log to output (docker logs, node console)
* Export to Komodo API (create Resource Sync, etc.)

## Inputs

### Stacks

KI can create Komodo [Stack](https://komo.do/docs/resources#stack) Resources from existing resources on your machine.

It will automatically detect what type of Stack to create based on the presence of git folders/data:

* Komodo **Files On Server** Stack => compose project/folder without a `.git` folder
* Komodo **Git Repo** Stacks => compose project/folder with a `.git` folder or with a parent folder containing a `.git` folder

#### Stack Sources

KI can generate Stacks from existing projects on your machine using one of two methods:

<Tabs groupId="stacksFrom" queryString>
  <TabItem value="dir" label="Directory">
    For **Directory** (`STACKS_FROM=dir`), Komodo Import will try to generate Stacks from each immediate **subfolder** inside the directory mounted into the container.


    <details>

    <summary>Example</summary>

    <TreeDirectory/>

    Using `STACKS_FROM=dir` with [host directory](#host-directory) `/home/myUser/homelab` would produce Stacks for `immich` `plex` and `uptime-kuma`.

    </details>

    </TabItem>
  <TabItem value="compose" label="Compose Projects">
    For **Compose Projects** (`STACKS_FROM=compose`), Komodo Import will try to generate Stacks from existing projects on your machine that were created with `docker compose up`.

    <details>

    <summary>Example</summary>

    <ComposeExample/>

    * Using `STACKS_FROM=dir` with [host directory](#host-directory) `/home/myUser` would produce Stacks for `immich` `plex` and `project1`.
    * It **would not** generate a Stack for `owncloud` since it was not created with `docker compose up` yet.

    </details>

    To use **Compose Projects** you must give Komodo Import access to Docker. This can be done by mounting `docker.sock` into the container or connecting it to a proxy service like [docker-socket-proxy](https://github.com/Tecnativa/docker-socket-proxy).

    <details>

    <summary>Using `socket-proxy` (recommended)</summary>

    Add a socket-proxy service to your compose file and set the env `DOCKER_HOST` so Komodo Import knows how to connect to Docker:

    ```yaml title="compose.yaml"
    services:
      komodo-import:
      # ...
        environment:
          # ...
          # add to existing environment
          - DOCKER_HOST=tcp://socket-proxy:2375
      socket-proxy:
        image: lscr.io/linuxserver/socket-proxy:latest
        environment:
          - CONTAINERS=1
          - INFO=1
          - POST=0
          - PING=1
          - VERSION=1
        volumes:
              - /var/run/docker.sock:/var/run/docker.sock:ro
        read_only: true
        tmpfs:
          - /run
    ```
    </details>

    <details>

    <summary>Mounting `docker.sock`</summary>

    Mount `/var/run/docker.sock` as a volume into the container:

    ```yaml title="compose.yaml"
    services:
      komodo-import:
      # ...
      volumes:
        # ...
        # add to existing volumes
        - /var/run/docker.sock:/var/run/docker.sock:ro
    ```
    </details>
  </TabItem>
</Tabs>

#### Host Directory

The directory on the **Host** machine that should be mounted into the Komodo Import container depends on which [Stack Source](#stack-sources) you are using.

* The host directory should be mounted to `/filesOnServer` in the container.
* **The host directory should also be set for `HOST_DIR` env.**

<Tabs groupId="stacksFrom" queryString>
  <TabItem value="dir" label="Directory">
    For **Directory** (`STACKS_FROM=dir`) use the **parent folder** containing all of the immediate **subfolders** that should be generated as Stacks.

    <details>

    <summary>Example</summary>

    <TreeDirectory/>

    Directory should be `home/myUser/homelab`:

    ```yaml title="compose.yaml"
    services:
      komodo-import:
      # ...
        volumes:
          - /home/myUser/homelab:/filesOnServer
        environment:
          - HOST_DIR=/home/myUser/homelab
    ```
    </details>

    </TabItem>
  <TabItem value="compose" label="Compose Projects">
    For **Compose Projects** (`STACKS_FROM=compose`) use the closest **parent folder** that contains all discovered compose project Config Files (`docker compose ls`).

    <details>

    <summary>Example</summary>

    <TreeCompose/>

    Directory should be `/home/myUser` because projects are found under both `localDev` and `homeLab`:

    ```yaml itle="compose.yaml"
    services:
      komodo-import:
      # ...
        volumes:
          - /home/myUser:/filesOnServer
        environment:
          - HOST_DIR=/home/myUser
    ```
    </details>
  </TabItem>
</Tabs>

#### Stack Configuration

The configuration and behaviors below are applicable to all Stacks:

<details>

<summary>Environmental Variables</summary>

| ENV                       | Required | Default                                | Description                                                                                                                                                  |
| :------------------------ | :------- | -------------------------------------- | :----------------------------------------------------------------------------------------------------------------------------------------------------------- |
| `SERVER_NAME`             | ☑️     |                                        | The name of the Komodo [Server](https://komo.do/docs/resources#server) where a Stack is located                                                              |
| `STACKS_FROM`             | ☑️     | `dir`                                  | What [**Stack Sources**](#stack-sources) to generate Stacks from? `dir` or `compose`                                                                                                     |
| `HOST_DIR`                | ☑️     |                                        | The parent directory on the **host** that mounted into the Komodo Import container                                                                           |
| `WRITE_ENV`               | -        | `true`                                 | Write the contents of found .env files to Komodo **Environment**. Likely want this as `true`.                                                                |
| `COMPOSE_FILE_GLOB`       | -        | `**/{compose,docker-compose}*.y?(a)ml` | The [glob](https://github.com/isaacs/node-glob?tab=readme-ov-file#glob-primer) pattern to use for finding files for **Files Paths** in Stack config          |
| `ENV_FILE_GLOB`           | -        | `**/.env`                              | The [glob](https://github.com/isaacs/node-glob?tab=readme-ov-file#glob-primer) pattern to use for finding files for **Additional Env Files** in Stack config |
| `KOMODO_ENV_NAME`         | -        | `.komodoenv`                           | If existing .env files are found, and `WRITE_ENV=false`, then this name will be used for the .env that Komodo writes using its own Environment section       |
| `IMAGE_REGISTRY_PROVIDER` | -        |                                        | Name of Image Registry to use                                                                                                                                |
| `IMAGE_REGISTRY_ACCOUNT`  | -        |                                        | Image Registry account to use                                                                                                                                |
| `POLL_FOR_UPDATE`         | -        |                                        | Poll for newer images?                                                                                                                                       |
| `AUTO_UPDATE`             | -        |                                        | Auto Update stack?                                                                                                                                           |

</details>

<details markdown="1">

<summary>Compose File Detection</summary>

* Default pattern
  * Looks for `compose.y(a)ml` and `docker-compose.y(a)ml` 
  * Files may have interim names like `compose.dev.yaml`
  * Can be overridden with `COMPOSE_FILE_GLOB` env for non-compose project stack sources
* Will prioritize `compose.yaml` over `docker-compose.yaml`
* Will choose the file with the shortest path EX
  * Prioritizes `./compose.yaml` over `./aFolder/compose.yaml`

Komodo Import will **log** which files it detects and indicate which ones it will use for each project.

:::note

When using [Compose Projects Stack Source](./?stacksFrom=compose#stack-sources) compose files are automatically parsed from the running projects.

:::

</details>

<details>

<summary>`.env` File Detection</summary>

* Default pattern 
  * Adds all `.env` files found at top-level or sub-folders
  * Can be overridden with `ENV_FILE_GLOB` env
* If a `.env` file is found and `WRITE_ENV=false` then a Stack is configured to write it's own Environment section to `.komodoenv` instead of `.env`
  * Komodo env name can be overridden with `KOMODO_ENV_NAME`

Komodo Import will **log** which files it detects and indicate which ones it will use for each project.

</details>


There is additional configuration available depending on the [Stack Source](#stack-sources):

<Tabs groupId="stacksFrom" queryString>
  <TabItem value="dir" label="Directory">

  * The `_GLOB` patterns are for matching folder names within the parent folder, not full directory paths
    * The default pattern matches all folder names except those starting with a `.`

| ENV                  | Required | Default | Description                                                                                                                                                      |
| :------------------- | :------- | ------- | :--------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| `FOLDER_GLOB`        | -        | `*`     | The [glob](https://github.com/isaacs/node-glob?tab=readme-ov-file#glob-primer) pattern to use for finding folders in the top-level folder given to Komodo Import |
| `FOLDER_IGNORE_GLOB` | -        |         | The [glob](https://github.com/isaacs/node-glob?tab=readme-ov-file#glob-primer) pattern to use to ignore folders in the top-level folder given to Komodo Import   |

    </TabItem>
  <TabItem value="compose" label="Compose Projects">

  * The `_GLOB` patterns are for matching **full directory paths**, not just a single folder name
    * The default pattern matches all directories except those that have any folder starting with a `.`
  * Komodo Import will **always** ignore projects created by Komodo itself (projects found in `/etc/komodo` or `/home/USER/komodo`)

| ENV                        | Required | Default | Description                                                                                                                                           |
| :------------------------- | :------- | ------- | :---------------------------------------------------------------------------------------------------------------------------------------------------- |
| `COMPOSE_FILE_GLOB`        | -        | `**/**` | The [glob](https://github.com/isaacs/node-glob?tab=readme-ov-file#glob-primer) pattern to use for matching a project's **full directory** on the host |
| `COMPOSE_FILE_IGNORE_GLOB` | -        |         | The [glob](https://github.com/isaacs/node-glob?tab=readme-ov-file#glob-primer) pattern to use to ignore a project's **full directory** on the host    |

  </TabItem>
</Tabs>

#### Git Repo Stacks

If a parsed folder (or parent of it) contains a `.git` folder and it has a valid tracked branch + remote, then it will generate a **Git Repo Stack**.

<details>

<summary>How Git Repository Parsing Works</summary>

* A folder is only built as a Git Repo stack if...
  * It contains a valid `.git` folder or a parent folder contains a `.git` folder
  * The git repo has a valid remote
  * The current checked out local branch is tracking a remote branch
  * If any of the above are not true then the folder is instead parsed as a Files On Server Stack

</details>

<details>

<summary>Example</summary>

You have two repositories at

* `https://git.mydomain.com/myUser/immich`
* `https://github.com/anotherUser/plex`

Your folder structure looks like this

```
/home/myUser/homelab
├── immich
│   ├── .git
│   └── compose.yaml
├── plex
│   ├── .git
│   └── docker-compose.yaml
└── uptime-kuma
    └── compose.yaml
```

* **immich** is created as a Git Repo Stack with
  * Git Provider: `git.mydomain.com`
  * Repo: `myUser/immich`
* **plex** is created as a Git Repo Stack with
  * Git Provider: `github.com`
  * Repo: `anotherUser/immich`
* **uptime-kuma** is created as a Files On Server Stack
  * Run Directory: `/home/myUser/homelab/uptime-kuma`
</details>

Additionally, if [**Komodo API is configured**](#komodo-api) then...

* If Komodo has a [Repo](https://komo.do/docs/resources#repo) Resource that matches the remote, then the Git Repo Stack uses a Linked Repo
* If Komodo has a Git Provider matching the remote URL domain then that is used, along with the Git Provider user (private git is automatically detected)

###### Monorepos

Komodo Import also handles **monorepos** IE one git repository with many folders containing projects. The only requirement to ensure this works is that the git repo "root" directory must be [mounted into Komodo Import.](#host-directory)

<Tabs groupId="stacksFrom" queryString>
  <TabItem value="dir" label="Directory">

    For [**Directory** Stack Source](./?stacksFrom=dir#stack-sources) use the root git repository directory as the [host directory](#host-directory).

    <details>

    <summary>Example</summary>

    ```
    /home/myUser/homelab
    ├── .git
    ├── immich
    │   └── compose.yaml
    ├── plex
    │   └── docker-compose.yaml
    └── uptime-kuma
        └── compose.yaml
    ```

    Use `/home/myUser/homelab` as the [host directory](#host-directory) because it contains `.git` folder.

    </details>

    If the directory containing your projects is not the root directory then use the ENV `SCAN_DIR` to set the path to use for projects _relative_ to the [host directory](#host-directory):

    <details>

      <summary>Example</summary>

      ```
      /home/myUser/homelab
      ├── .git
      ├── myStacks   <---- parent folder containing projects
      │   ├── immich
      │   │   └── compose.yaml
      │   ├── plex
      │   │   └── docker-compose.yaml
      │   └── uptime-kuma
      │       └── compose.yaml
      └── somethingElse
      ```

      * Use `/home/myUser/homelab` as the [host directory](#host-directory) because it contains `.git` folder
      * Use `SCAN_DIR=myStacks` -- the folder Komodo Import will parse projects from, _relative_ to the host directory `/home/myUser/homelab`
      </details>

    </TabItem>
  <TabItem value="compose" label="Compose Projects">

  Komodo Import will automatically determine if a project is in a monorepo by scanning all parent directories for `.git` folder. Just make sure the mounted [host directory](#host-directory) contains the monorepo folder at some level.

  </TabItem>
</Tabs>

## Outputs

### Console

KI will always output the raw TOML form of a [Sync Resource](https://komo.do/docs/sync-resources) to console unless the env `LOG_TOML=false`.

You'll see this in docker logs or node's console like this:

```
[2025-08-11 14:06:19.119 -0400] INFO   : [App] Copy the text between the scissors to use as the *Resource File* contents within your Resource Sync

✂️  ✂️  ✂️  ✂️  ✂️  ✂️  ✂️  ✂️  ✂️  ✂️  ✂️  ✂️
[[stack]]
name = "compose"

[stack.config]
server = "my-cool-server"
run_directory = "/home/myUser/homelab/compose"

...

✂️  ✂️  ✂️  ✂️  ✂️  ✂️  ✂️  ✂️  ✂️  ✂️  ✂️  ✂️
[2025-08-11 14:06:19.119 -0400] INFO   : [App] Done!
```

Use this with [manually creating Sync Resources](../resourceSync#create-sync-resource)

:::tip
Use `--no-log-prefix` to get output without the service name prefix, makes getting clear TOML output easier.

```
docker compose up --no-log-prefix
```
:::

### API Sync

Komodo Import can **directly create Sync Resources in Komodo** using Komodo's API. **This output will only create the Sync, it will not execute it.** After creating the Sync you should [verify its content before executing.](../resourceSync#verify-sync-changes)

First, follow the instructions and configuration in the [Komodo API](#komodo-api) section.

:::note

Currently, the user creating the Api Key must be an **Admin** to create Sync Resources (but this will hopefully be more granular in the future).

:::

Then, add these environmental variables to Komodo Import:

<details>

<summary>Environmental Variables</summary>

| ENV               | Required | Default       | Description                                                              |
| :---------------- | :------- | :------------ | :----------------------------------------------------------------------- |
| `OUTPUT_API_SYNC` | ☑️     | `false`       | Must be `true` to activate API Sync                                      |
| `EXISTING_SYNC`   | -        | append        | Behavior if Resource Sync already exists. Either `append` or `overwrite` |
| `SYNC_NAME`       | -        | komodo-import | Name of Sync to create/modify                                            |

</details>

## Komodo API

Komodo Import can take advantage of your existing Komodo instance to configure Stacks with linked repos, write Resource Syncs directly, etc...

You will need to create an API Key and Secret to use the API.

<details>

<summary>API Key Creation Instructions</summary>

Navigate to your Komodo Web UI:

* Open **Settings** -> **Profile**
* Click **New Api Key**
  * Give it a name and optional Expiry
  * Create the key and Copy the show **Key** and **Secret**

</details>

#### API Configuration

Add these environmental variables to Komodo Import to use the Komodo API.

<details>

<summary>Environmental Variables</summary>

| ENV          | Required | Default | Description       |
| :----------- | :------- | ------- | :---------------- |
| `KOMODO_URL` | ☑️     |         | Komodo Server URL |
| `API_KEY`    | ☑️     |         | Komodo API Key    |
| `API_SECRET` | ☑️     |         | Komodo API Secret |

</details>

Your Komodo URL should be as specific as possible, including port if required. Some examples of valid urls:

* `http://192.168.0.100:9120`
* `https://komodo.mydomain.com`
* `https://myKomodo.com`
* `http://komodo` (in docker network, for example)